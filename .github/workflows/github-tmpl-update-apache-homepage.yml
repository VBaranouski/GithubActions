name: Reusable workflow - Update Apache Homepage
# This workflow runs the update of Apache Homepage based on env, name and page_text variables
# This workflow requeires the following variables:
# - environment: development, stage, prod
# - name - name of author
# - page_text - plain text

on: 
  workflow_call:
    inputs:            # Variables For Automatic Run
      environment:
        type: string
      name: 
        type: string
      page_text: 
        type: string

  workflow_dispatch: 
    inputs:            # Variables For Manual Run
      environment:     
        type: choice
        options: 
          - development
          - staging
          - prod
      name:
        type: string
        default: Vlad
      page_text: 
        type: string
        default: Привет из шаблона пайплайна
        
env:
  NAME: "${{ inputs.name }}"
  PAGE_TEXT: "${{ inputs.page_text }}"


jobs:
  validate_inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Environment Variable
        run: |
             if [[ -z "${{ inputs.environment }}" ]]; then
               echo " ERROR: Environment is not defined"
               exit 1
             fi

# вот тут надо подумать....
      - name: Validate Name Variable
        run: |
             if [[ -z "${{ env.NAME }}" ]]; then
                echo "NAME=Default_Name_auto" >> $GITHUB_ENV
             fi
 # вот тут надо подумать....     
      - name: Validate Page Text Variable
        run: |
          if [[ -z "${{ env.PAGE_TEXT }}" ]]; then
            echo "PAGE_TEXT=Default_Page_Text_auto" >> $GITHUB_ENV
          fi

  create_homepage: 
    runs-on: ubuntu-latest
    needs: validate_inputs
    env:
      HTML_FILE: "ApacheHomepage.html"
    steps:
        - name: Clone Repository "${{ github.repository }}"
          uses: actions/checkout@v4

        - name: Run Unit tests
          run: echo "do some unit testing"

        - name: Check if the environment is Prod
          run: |
             if [[ "${{ inputs.environment }}" == "Prod" ]]; then
               echo " ERROR is ${{ inputs.environment }}. Stopping the pipline "
               exit 1
             fi
          
        - name: Update Apache Homepage
          if: success()
          run: |
                echo "${{ inputs.environment }}, ${{ inputs.name }}, ${{ inputs.page_text }}" > "${{ env.HTML_FILE }}"
                cat "${{ env.HTML_FILE }}"

        - name: Call Script For Pushing To "${{ github.repository }}"
          continue-on-error: true
          run: bash .scripts/push-to-repo.sh

        - name: Deploy Docker Image
          run: bash .scripts/build-docker-image.sh
        
  
